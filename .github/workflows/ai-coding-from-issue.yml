name: AI Coding from Issue with Cline

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  ai-coding:
    if: contains(github.event.issue.labels.*.name, 'cline-coding')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: npm ci

      - name: Install Cline CLI
        run: |
          npm install -g cline
          cline version

      - name: Create feature branch (human-readable & unique)
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          RUN_ID="${{ github.run_id }}"

          # ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã‚ã‚‹ç¨‹åº¦å®‰å…¨ãª ASCII ã«å¤‰æ›ï¼ˆå¤±æ•—ã—ãŸå ´åˆã¯å…ƒã®æ–‡å­—åˆ—ã‚’ä½¿ç”¨ï¼‰
          SAFE_TITLE=$(echo "$ISSUE_TITLE" | iconv -f UTF-8 -t ASCII//TRANSLIT 2>/dev/null || echo "$ISSUE_TITLE")

          # å°æ–‡å­—ã«å¤‰æ›
          SAFE_TITLE=$(echo "$SAFE_TITLE" | tr '[:upper:]' '[:lower:]')

          # è‹±æ•°å­—ä»¥å¤–ã‚’ "-" ã«ç½®ãæ›ãˆ
          SAFE_TITLE=$(echo "$SAFE_TITLE" | sed 's/[^a-z0-9]/-/g')

          # é€£ç¶šã—ãŸ "-" ã‚’ 1 ã¤ã«ã¾ã¨ã‚ã‚‹
          SAFE_TITLE=$(echo "$SAFE_TITLE" | sed 's/-\+/-/g')

          # å…ˆé ­ã¨æœ«å°¾ã® "-" ã‚’å‰Šé™¤
          SAFE_TITLE=$(echo "$SAFE_TITLE" | sed 's/^-//' | sed 's/-$//')

          # é•·ã™ãã‚‹å ´åˆã¯ 40 æ–‡å­—ã«åˆ‡ã‚Šè©°ã‚
          SAFE_TITLE=$(echo "$SAFE_TITLE" | cut -c1-40)

          # æœ€çµ‚çš„ã«ç©ºã«ãªã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if [ -z "$SAFE_TITLE" ]; then
            SAFE_TITLE="update"
          fi

          BRANCH_NAME="ai-fix-issue-${ISSUE_NUM}-${SAFE_TITLE}-run-${RUN_ID}"

          echo "Using branch name: $BRANCH_NAME"

          git config user.name "Cline AI Bot"
          git config user.email "cline-bot@github.com"
          git checkout -b "$BRANCH_NAME"

          # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ç”¨ã«ç’°å¢ƒå¤‰æ•°ã¸ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Run Cline AI Coding
        env:
          OPEN_ROUTER_API_KEY: ${{ secrets.OPEN_ROUTER_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          cline auth --provider "openrouter" --apikey "$OPEN_ROUTER_API_KEY" --modelid "openai/gpt-5.1" || true

          echo "Issue #${{ github.event.issue.number }}: " > /tmp/prompt.txt
          printf '%s\n' "$ISSUE_TITLE" >> /tmp/prompt.txt
          echo "" >> /tmp/prompt.txt
          printf '%s\n' "$ISSUE_BODY" >> /tmp/prompt.txt
          echo "" >> /tmp/prompt.txt
          echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒ«ï¼ˆ.clinerules ãªã©ï¼‰:" >> /tmp/prompt.txt
          echo "- å¤‰æ›´ç®‡æ‰€ã«ã¯å¿…è¦ã«å¿œã˜ã¦ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ï¼ˆã¾ãŸã¯ Storybookï¼‰ã‚’è¿½åŠ ãƒ»æ›´æ–°ã™ã‚‹ã“ã¨" >> /tmp/prompt.txt
          echo "- ã‚¿ã‚¹ã‚¯å®Œäº†å¾Œã¯ npm run lint / npm run build ã‚’å®Ÿè¡Œã—ã€ã‚¨ãƒ©ãƒ¼ã®ãªã„çŠ¶æ…‹ã«ã™ã‚‹ã“ã¨" >> /tmp/prompt.txt
          echo "" >> /tmp/prompt.txt
          echo "ä½œæ¥­æ–¹é‡:" >> /tmp/prompt.txt
          echo "- ã‚³ãƒ¼ãƒ‰ã®æ„å›³ã‚’èª­ã¿å–ã‚Šã¤ã¤ã€å®‰å…¨ã«å¤‰æ›´ã‚’åŠ ãˆã‚‹ã“ã¨" >> /tmp/prompt.txt
          echo "- æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ãƒ»æ§‹æˆã«åˆã‚ã›ã‚‹ã“ã¨" >> /tmp/prompt.txt
          echo "- å¯èƒ½ãªç¯„å›²ã§ä¸å¯§ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¡Œã†ã“ã¨" >> /tmp/prompt.txt
          echo "- å¿…è¦ã«å¿œã˜ã¦ãƒ†ã‚¹ãƒˆã‚„ãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œæ–¹æ³•ã‚‚æ›´æ–°ã™ã‚‹ã“ã¨" >> /tmp/prompt.txt

          if ! cline -y -m act < /tmp/prompt.txt; then
            echo "Cline ãŒä¸€åº¦å¤±æ•—ã—ãŸãŸã‚ã€æ•°ç§’å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¾ã™..."
            sleep 5
            cline -y -m act < /tmp/prompt.txt
          fi

      - name: Run project checks
        id: checks
        continue-on-error: true
        run: |
          npm run lint
          LINT_EXIT=$?
          npm run build
          BUILD_EXIT=$?

          if [ "$LINT_EXIT" -ne 0 ] || [ "$BUILD_EXIT" -ne 0 ]; then
            CHECKS_EXIT=1
          else
            CHECKS_EXIT=0
          fi

          echo "checks_result=$CHECKS_EXIT" >> $GITHUB_OUTPUT

      - name: Fix checks failures if needed
        if: steps.checks.outputs.checks_result != '0'
        env:
          OPEN_ROUTER_API_KEY: ${{ secrets.OPEN_ROUTER_API_KEY }}
        run: |
          echo "npm run lint / npm run build ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚Cline ã«ä¿®æ­£ã‚’ä¾é ¼ã—ã¾ã™..." > /tmp/fix_prompt.txt
          echo "" >> /tmp/fix_prompt.txt
          echo "æ¬¡ã®æ–¹é‡ã§å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„:" >> /tmp/fix_prompt.txt
          echo "- npm run lint ã®å‡ºåŠ›ã‚’ç¢ºèª" >> /tmp/fix_prompt.txt
          echo "- npm run build ã®å‡ºåŠ›ã‚’ç¢ºèª" >> /tmp/fix_prompt.txt
          echo "- ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’ç‰¹å®šã—ã€å¿…è¦ãªã‚³ãƒ¼ãƒ‰ä¿®æ­£ã¨ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®è£œå®Œã‚’è¡Œã†" >> /tmp/fix_prompt.txt
          echo "- ä¿®æ­£å¾Œã« npm run lint / npm run build ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª" >> /tmp/fix_prompt.txt

          cline -y -m act < /tmp/fix_prompt.txt
          npm run lint
          npm run build

      - name: Commit and push changes
        id: commit
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add .

            echo "ç¾åœ¨ã®å¤‰æ›´å†…å®¹ï¼ˆgit diff --stagedï¼‰ã¨ Issue ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã‚‚ã¨ã«ã€Conventional Commits å½¢å¼ã®åˆ†ã‹ã‚Šã‚„ã™ã„ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚" > /tmp/commit_prompt.txt
            echo "" >> /tmp/commit_prompt.txt
            echo "## è¦ä»¶" >> /tmp/commit_prompt.txt
            echo "- 1è¡Œç›®ã¯ 'type: subject' å½¢å¼ã§ 50 æ–‡å­—ä»¥å†…" >> /tmp/commit_prompt.txt
            echo "- 2è¡Œç›®ã¯ç©ºè¡Œã¨ã™ã‚‹" >> /tmp/commit_prompt.txt
            echo "- 3è¡Œç›®ä»¥é™ã«è©³ç´°ãªèª¬æ˜ã‚’æ›¸ã" >> /tmp/commit_prompt.txt
            echo "- å¿…ãš <COMMIT_MESSAGE> ã¨ </COMMIT_MESSAGE> ã‚¿ã‚°ã®é–“ã«ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¨æ–‡ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨" >> /tmp/commit_prompt.txt
            echo "" >> /tmp/commit_prompt.txt
            echo "## Issue ã‚¿ã‚¤ãƒˆãƒ«" >> /tmp/commit_prompt.txt
            printf '%s\n' "$ISSUE_TITLE" >> /tmp/commit_prompt.txt
            echo "" >> /tmp/commit_prompt.txt
            echo "## å¤‰æ›´å†…å®¹" >> /tmp/commit_prompt.txt
            git diff --staged >> /tmp/commit_prompt.txt

            cline -y -m act < /tmp/commit_prompt.txt > /tmp/raw_commit_msg.txt

            # <COMMIT_MESSAGE> ã‚¿ã‚°ã®ä¸­èº«ã®ã¿æŠ½å‡º
            sed -n '/<COMMIT_MESSAGE>/,/<\/COMMIT_MESSAGE>/p' /tmp/raw_commit_msg.txt | sed 's/<COMMIT_MESSAGE>//;s/<\/COMMIT_MESSAGE>//' > /tmp/ai_commit_msg.txt

            git commit -F /tmp/ai_commit_msg.txt

            # feature ãƒ–ãƒ©ãƒ³ãƒã‚’ push
            git push origin "$BRANCH_NAME"

            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate PR title and body
        if: steps.commit.outputs.has_changes == 'true'
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "ä»¥ä¸‹ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ã€åˆ†ã‹ã‚Šã‚„ã™ã„ Pull Request ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚" > /tmp/pr_prompt.txt
          echo "" >> /tmp/pr_prompt.txt
          echo "## è¦ä»¶" >> /tmp/pr_prompt.txt
          echo "- ã‚¿ã‚¤ãƒˆãƒ«ã¯ 'feat: ...' / 'fix: ...' ãªã©ã®å½¢å¼ã§ã€è¦ç‚¹ãŒåˆ†ã‹ã‚‹ã‚ˆã†ã«ã™ã‚‹" >> /tmp/pr_prompt.txt
          echo "- æœ¬æ–‡ã«ã¯å¯¾å¿œã—ãŸ Issue ç•ªå·ã€å¤‰æ›´å†…å®¹ã®æ¦‚è¦ã€ãƒ†ã‚¹ãƒˆçµæœãªã©ã‚’å«ã‚ã‚‹" >> /tmp/pr_prompt.txt
          echo "- ã‚¿ã‚¤ãƒˆãƒ«ã¯ <PR_TITLE> ã¨ </PR_TITLE> ã®é–“ã«å‡ºåŠ›ã™ã‚‹" >> /tmp/pr_prompt.txt
          echo "- æœ¬æ–‡ã¯ <PR_BODY> ã¨ </PR_BODY> ã®é–“ã«å‡ºåŠ›ã™ã‚‹" >> /tmp/pr_prompt.txt
          echo "" >> /tmp/pr_prompt.txt
          echo "## Issue" >> /tmp/pr_prompt.txt
          echo "#${{ github.event.issue.number }}: " >> /tmp/pr_prompt.txt
          printf '%s\n' "$ISSUE_TITLE" >> /tmp/pr_prompt.txt
          printf '%s\n' "$ISSUE_BODY" >> /tmp/pr_prompt.txt
          echo "" >> /tmp/pr_prompt.txt
          echo "## ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" >> /tmp/pr_prompt.txt
          cat /tmp/ai_commit_msg.txt >> /tmp/pr_prompt.txt
          echo "" >> /tmp/pr_prompt.txt
          echo "## å¤‰æ›´å·®åˆ†" >> /tmp/pr_prompt.txt
          git diff origin/main...HEAD >> /tmp/pr_prompt.txt

          cline -y -m act < /tmp/pr_prompt.txt | python .github/scripts/extract_pr_details.py /tmp/ai_pr_title.txt /tmp/ai_pr_body.txt

      - name: Create Pull Request
        if: steps.commit.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_TITLE=$(cat /tmp/ai_pr_title.txt)

          gh pr create \
            --title "$PR_TITLE" \
            --body-file /tmp/ai_pr_body.txt \
            --base main \
            --head "$BRANCH_NAME" \
            --label "ai-generated" \
            --label "needs-review"

          PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number')
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV

      - name: Comment on Issue (Success)
        if: success() && steps.commit.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        env:
          COMMENT_BODY: |
            âœ… **Cline AI ã«ã‚ˆã‚‹ PR ã‚’ä½œæˆã—ã¾ã—ãŸ**

            âœ… ãƒã‚§ãƒƒã‚¯ï¼ˆnpm run lint / npm run buildï¼‰ã‚‚æˆåŠŸã—ã¦ã„ã¾ã™ã€‚

            ğŸ”— ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™: #${{ env.PR_NUMBER }}

            ---
            Generated by [Cline](https://cline.bot)
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: process.env.COMMENT_BODY
            })

      - name: Comment on Issue (Failure)
        if: failure()
        uses: actions/github-script@v7
        env:
          COMMENT_BODY: |
            âŒ **Cline AI ã«ã‚ˆã‚‹è‡ªå‹•å¯¾å¿œã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ**

            ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã¯ [Actions ãƒ­ã‚°](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

            è€ƒãˆã‚‰ã‚Œã‚‹åŸå› :
            - Issue ã®å†…å®¹ãŒä¸ååˆ†
            - ä¾å­˜é–¢ä¿‚ã‚„ãƒ“ãƒ«ãƒ‰è¨­å®šã®å•é¡Œ
            - API ãƒ¬ãƒ¼ãƒˆåˆ¶é™
            - ãƒ†ã‚¹ãƒˆã¾ãŸã¯ãƒ“ãƒ«ãƒ‰ã®å¤±æ•—

            å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§å¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: process.env.COMMENT_BODY
            })

      - name: Add labels to Issue
        if: success() && steps.commit.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['ai-processed']
            })
