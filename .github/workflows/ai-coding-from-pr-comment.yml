name: AI Fix from PR Comment with Cline

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  ai-pr-followup:
    if: github.event.issue.pull_request && (contains(github.event.comment.body, '@Cline') || contains(github.event.comment.body, '@cline'))
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;

            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: issue_number,
            });

            core.setOutput('pr_number', issue_number.toString());
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_repo', pr.head.repo.full_name);
            core.setOutput('is_fork', pr.head.repo.full_name !== `${owner}/${repo}`);
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('pr_title', pr.title || '');
            core.setOutput('pr_body', pr.body || '');

      - name: Comment on forked PR
        if: steps.pr.outputs.is_fork == 'true'
        uses: actions/github-script@v7
        env:
          COMMENT_BODY: |
            Thanks for the request. This workflow cannot push changes to forked PRs.
            Please apply the changes in the fork or open the PR from the main repo.
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: process.env.COMMENT_BODY
            })

      - name: Checkout PR branch
        if: steps.pr.outputs.is_fork != 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr.outputs.head_repo }}
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0

      - name: Setup Node.js
        if: steps.pr.outputs.is_fork != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        if: steps.pr.outputs.is_fork != 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install dependencies
        if: steps.pr.outputs.is_fork != 'true'
        run: npm ci

      - name: Install Cline CLI
        if: steps.pr.outputs.is_fork != 'true'
        run: |
          npm install -g cline@1.0.7
          cline version

      - name: Run Cline for requested PR changes
        if: steps.pr.outputs.is_fork != 'true'
        env:
          OPEN_ROUTER_API_KEY: ${{ secrets.OPEN_ROUTER_API_KEY }}
          PR_TITLE: ${{ steps.pr.outputs.pr_title }}
          PR_BODY: ${{ steps.pr.outputs.pr_body }}
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          cline auth --provider "openrouter" --apikey "$OPEN_ROUTER_API_KEY" --modelid "google/gemini-3-flash-preview" || true
          git fetch origin "${{ steps.pr.outputs.base_ref }}"

          echo "PR #$PR_NUMBER: $PR_TITLE" > /tmp/pr_fix_prompt.txt
          printf '%s\n' "$PR_BODY" >> /tmp/pr_fix_prompt.txt
          echo "" >> /tmp/pr_fix_prompt.txt
          echo "## Request from PR comment" >> /tmp/pr_fix_prompt.txt
          echo "@$COMMENT_AUTHOR" >> /tmp/pr_fix_prompt.txt
          printf '%s\n' "$COMMENT_BODY" >> /tmp/pr_fix_prompt.txt
          echo "" >> /tmp/pr_fix_prompt.txt
          echo "## Guidance" >> /tmp/pr_fix_prompt.txt
          echo "- Apply the requested changes to this PR branch." >> /tmp/pr_fix_prompt.txt
          echo "- Keep changes minimal and consistent with existing style." >> /tmp/pr_fix_prompt.txt
          echo "- Update tests if needed, but do not run them." >> /tmp/pr_fix_prompt.txt
          echo "" >> /tmp/pr_fix_prompt.txt
          echo "## Current diff (base -> head)" >> /tmp/pr_fix_prompt.txt
          git diff "origin/${{ steps.pr.outputs.base_ref }}...HEAD" >> /tmp/pr_fix_prompt.txt

          if ! cline -y -m act < /tmp/pr_fix_prompt.txt; then
            echo "Cline failed once; retrying after a short delay..."
            sleep 5
            cline -y -m act < /tmp/pr_fix_prompt.txt
          fi

      - name: Commit and push updates
        if: steps.pr.outputs.is_fork != 'true'
        id: commit
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git config user.name "Cline AI Bot"
            git config user.email "cline-bot@github.com"

            SUBJECT="$(printf '%s' "$COMMENT_BODY" | head -n 1 | sed 's/@[Cc]line//g' | sed 's/^[[:space:]]*//' | cut -c1-50)"
            if [ -z "$SUBJECT" ]; then
              SUBJECT="address PR feedback"
            fi

            git commit -m "fix: $SUBJECT"
            git push origin HEAD

            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "last_commit=$(git log -1 --pretty=%H)" >> $GITHUB_OUTPUT
            echo "last_subject=$(git log -1 --pretty=%s)" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR (updated)
        if: steps.pr.outputs.is_fork != 'true' && steps.commit.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        env:
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          LAST_COMMIT: ${{ steps.commit.outputs.last_commit }}
          LAST_SUBJECT: ${{ steps.commit.outputs.last_subject }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = [
              `@${process.env.COMMENT_AUTHOR} updates have been pushed to this PR.`,
              `- Commit: ${process.env.LAST_SUBJECT} (${process.env.LAST_COMMIT})`,
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            })

      - name: Comment on PR (no changes)
        if: steps.pr.outputs.is_fork != 'true' && steps.commit.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        env:
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `@${process.env.COMMENT_AUTHOR} no code changes were made for this request. Please clarify the desired update.`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            })
